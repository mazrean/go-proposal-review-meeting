# Implementation Plan

## Task Overview

Go Proposal Weekly Digestシステムの実装タスク。7つの要件を8つのコンポーネントで実現する。

---

## Tasks

- [ ] 1. プロジェクト基盤セットアップ
- [x] 1.1 Go moduleと依存関係の初期化
  - Go 1.22+でmodule初期化、主要依存関係を追加
  - templ v0.3+、gopherlibs/feedhubを追加
  - ディレクトリ構造（cmd/、internal/、content/、dist/）を作成
  - Makefileまたはタスクランナーでビルドコマンドを定義
  - ※ 1.2に先行して完了する必要あり

- [x] 1.2 フロントエンド開発環境の構築
  - Node.js依存関係（UnoCSS、esbuild、Lit）をpackage.jsonに定義
  - UnoCSS設定ファイルでtemplファイルからのクラス抽出を設定
  - esbuild設定でLitコンポーネントのバンドルを構成
  - ※ 1.1のディレクトリ構造に依存

- [ ] 2. Parserドメインの実装
- [x] 2.1 (P) 状態管理機能の実装
  - 前回処理日時とコメントIDを記録する仕組みを構築
  - state.jsonファイルの読み書き機能を実装
  - 初回実行時のデフォルト状態（1ヶ月前）を設定
  - _Requirements: 1.2_

- [x] 2.2 (P) Minutesパース機能の実装
  - Proposal review minutesのテキストフォーマットを解析
  - 各ステータス（Discussions、Accepted、Declined、Likely Accept、Active、Hold）を検出
  - proposal番号とタイトルの抽出ロジックを実装
  - 日付ヘッダーから変更日時を取得
  - フォーマット不一致時の警告ログ出力
  - _Requirements: 1.3_

- [x] 2.3 GitHub Issue取得機能の実装
  - GitHub REST APIでissue #33502のコメントを取得
  - ETAGキャッシュによるレート制限対策を実装
  - 状態管理と連携して新規コメントのみをフィルタリング
  - エラー発生時のログ記録と継続可能な状態維持
  - 変更データをJSON形式で出力
  - ※ 2.1, 2.2に依存
  - _Requirements: 1.1, 1.2, 1.4, 1.5_

- [x] 2.4 Parserドメインの単体テスト
  - MinutesParserの各ステータスパターンのパース検証
  - StateManagerの状態読み書き、初回実行時の挙動テスト
  - エラーケース（不正フォーマット、API失敗）のテスト
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 1.5_

- [ ] 3. Contentドメインの実装
- [x] 3.1 週次コンテンツ構造の管理
  - 週ごとのディレクトリ構造（content/YYYY/WXX/）を作成
  - 各proposalのMarkdownファイル生成
  - frontmatter形式でメタデータ（proposal番号、タイトル、ステータス、リンク）を出力
  - ※ Parserドメイン（2.x）に依存
  - _Requirements: 2.1, 2.2, 2.3_

- [x] 3.2 コンテンツ差分マージ機能の実装
  - 同一週内で複数回更新があった場合の差分マージ
  - 既存ファイルを上書きせず、変更を統合
  - 過去の週次データを変更せず保持
  - ※ 3.1のコンテンツ構造に依存
  - _Requirements: 2.4, 2.5_

- [x] 3.3 AI要約統合とフォールバック
  - Claude Code Actionが生成した要約ファイルを読み込み
  - 要約をMarkdownコンテンツに統合
  - 要約に含まれる関連GitHub issueリンクをMarkdownに埋め込み
  - 要約ファイルがない場合のフォールバックテキストを適用
  - API失敗時に基本情報（proposal番号、タイトル、ステータス変更）のみを出力
  - _Requirements: 3.3, 3.4_

- [x] 3.4 Contentドメインの単体テスト
  - ディレクトリ生成、Markdownファイル出力のテスト
  - 差分マージのパターンテスト
  - フォールバック処理のテスト（要約あり/なし両方）
  - 要約に理由/背景/関連リンクが含まれるかの検証
  - 要約の文字数が200-500文字範囲内かの検証
  - _Requirements: 2.1, 2.2, 2.3, 2.4, 2.5, 3.2, 3.3, 3.4, 3.5_

- [ ] 4. Siteドメインの実装
- [x] 4.1 templテンプレートによるページレイアウト定義
  - 型安全なtemplコンポーネントで基本レイアウトを定義
  - ヘッダー、フッター、ナビゲーションの共通コンポーネント
  - ※ 1.1, 1.2に依存
  - _Requirements: 4.1_

- [x] 4.2 週次インデックスページテンプレート
  - 週ごとのインデックスページテンプレート作成
  - proposal一覧の表示ロジック
  - ※ 4.1の基本レイアウトに依存
  - _Requirements: 4.1, 4.3_

- [x] 4.3 個別proposalページテンプレート
  - 個別proposalページテンプレート作成
  - 要約、ステータス変更、リンクの表示
  - ※ 4.1の基本レイアウトに依存
  - _Requirements: 4.1, 4.3_

- [x] 4.4 サイト全体インデックスページ
  - 週一覧を表示するトップページ
  - 最新更新への導線
  - ※ 4.1の基本レイアウトに依存
  - _Requirements: 4.1, 4.3_

- [x] 4.5 ステータス表示とスタイリング
  - proposalステータス変化を視覚的に目立たせるコンポーネント
  - UnoCSS CLIでtemplファイルからCSSを抽出
  - ステータスバッジのスタイル定義
  - ※ 4.1-4.4のテンプレートに依存
  - _Requirements: 4.2, 4.4_

- [x] 4.6 Lit Web Componentの実装
  - 動的UIが必要な箇所のLitコンポーネント作成
  - esbuildでコンポーネントをバンドル
  - HTMLへの埋め込み用スクリプトタグ生成
  - ※ 1.2のesbuild設定と4.5のスタイルに依存
  - _Requirements: 4.5, 4.6_

- [x] 4.7 静的サイト生成コマンドの実装
  - templ generateコマンドの実行
  - コンテンツデータの読み込みとHTML出力
  - dist/ディレクトリへの配置
  - ※ 4.1-4.6のテンプレートとコンポーネント、3.xのコンテンツに依存
  - _Requirements: 4.1, 4.3_

- [x] 4.8 HTMLビルドオーケストレーション
  - templ generate → UnoCSS抽出 → esbuild bundle の実行順序制御
  - Makefileまたはスクリプトでワンコマンド化
  - ※ 4.7に依存
  - _Requirements: 4.4, 4.5, 4.6_

- [x] 4.9 RSS統合とフルビルドコマンド
  - 4.8のHTMLビルドとRSS生成を統合
  - make buildで全成果物を生成
  - ※ 4.8および5.1, 5.2に依存
  - _Requirements: 5.1, 5.4_

- [x] 4.10 Siteドメインの統合テスト
  - templ + UnoCSS + esbuildの統合ビルド検証
  - 生成されたHTML/CSS/JSの妥当性チェック
  - _Requirements: 4.1, 4.2, 4.3, 4.4, 4.5, 4.6_

- [ ] 5. Feedドメインの実装
- [x] 5.1 RSSフィード生成機能
  - gopherlibs/feedhubでRSS 2.0フィードを構築
  - 週次更新をフィードアイテムとして追加
  - 各アイテムにproposalタイトル、ステータス変更、要約を含める
  - 最新20件の更新に制限
  - ※ 3.xのコンテンツに依存
  - _Requirements: 5.1, 5.2, 5.3, 5.5_

- [x] 5.2 フィードautodiscoveryの統合
  - HTMLヘッダーにRSSフィードのautodiscoveryタグを追加
  - templテンプレートでの動的URL生成
  - ※ 4.1のテンプレートと5.1のフィード生成に依存
  - _Requirements: 5.4_

- [x] 5.3 Feedドメインの単体テスト
  - RSS 2.0フォーマット準拠の検証
  - 20件制限のテスト
  - フィードの妥当性チェック
  - ※ 5.1, 5.2に依存
  - _Requirements: 5.1, 5.2, 5.3, 5.4, 5.5_

- [ ] 6. GitHub Actionsワークフローの実装
- [x] 6.1 週次スケジュールトリガーの設定
  - cron設定で毎週木曜日12:00 JSTにトリガー
  - 手動実行（workflow_dispatch）も可能に
  - _Requirements: 6.1_

- [x] 6.2 Parseステップの実装
  - IssueParserを実行して変更を取得
  - 変更データをchanges.jsonに出力
  - ステップ出力として変更有無フラグを設定
  - ※ 6.1およびParserドメイン（2.1-2.3）に依存
  - _Requirements: 6.1_

- [x] 6.3 変更検出とスキップ制御
  - 変更がない場合に後続ステップをスキップ
  - GitHub Actionsの条件分岐（if文）で制御
  - スキップ時のログ出力
  - ※ 6.2に依存
  - _Requirements: 6.2_

- [x] 6.4 Claude Code Actionによる要約生成ステップ
  - anthropics/claude-code-action@v1を使用
  - 変更データ（changes.json）を読み込み
  - 構造化出力で各proposalの日本語要約を生成
  - ステータス変更の理由と技術的背景を含めるようプロンプトで指示
  - 関連するGitHub issueへのリンクを要約に含めるようプロンプトで指示
  - 200-500文字の文字数制限をプロンプトで制御
  - 要約ファイル（summaries/）への出力
  - ※ 6.3に依存
  - _Requirements: 3.1, 3.2, 3.3, 3.5_

- [x] 6.5 要約生成失敗時のハンドリング
  - Claude Code Action失敗時のcontinue-on-error設定
  - 失敗フラグをステップ出力として伝播
  - 後続のフォールバック処理へ連携
  - ※ 6.4に依存
  - _Requirements: 3.4_

- [x] 6.6 ビルドステップの実装
  - 静的サイト再生成の実行
  - 変更検出後のみ実行される条件分岐
  - ※ 6.4/6.5（要約生成）完了後に実行
  - _Requirements: 6.2_

- [x] 6.7 コミットステップの実装
  - mainブランチへの直接コミット
  - 生成されたHTML/CSS/JS/RSSをコミットに含める
  - 変更がある場合のみコミット
  - ※ 6.6に依存
  - _Requirements: 6.3_

- [x] 6.8 Cloudflare本番デプロイ設定
  - wrangler v4でCloudflareにデプロイ
  - mainブランチ更新時に本番デプロイ
  - ※ 6.7に依存
  - _Requirements: 6.4_

- [x] 6.9 PRビルドワークフロー設定
  - PRイベントで静的サイト生成を実行
  - ビルド成果物をアーティファクトとして保存
  - _Requirements: 6.5_

- [x] 6.10 プレビューデプロイ設定
  - Cloudflareプレビュー環境にデプロイ
  - PRコメントにプレビューURLを投稿
  - ※ 6.9に依存
  - _Requirements: 6.5_

- [x] 6.11 エラー通知の設定
  - デプロイ失敗時のエラー通知（Webhook）
  - ワークフロー失敗時の通知設定
  - ※ 6.8/6.10のデプロイステップに依存
  - _Requirements: 6.6_

- [ ] 7. CIドメイン（PR差分確認）の実装
- [ ] 7.1 HTML差分計算機能
  - mainブランチとの静的ファイル差分を計算
  - 追加・削除・変更ファイル一覧を生成
  - 差分が大きい場合の要約ロジック
  - _Requirements: 7.1, 7.3, 7.4_

- [ ] 7.2 PRコメント投稿機能
  - GitHub APIでPRコメントを投稿
  - 差分サマリーのフォーマット
  - 既存コメントの更新（新規作成ではなく）
  - ※ 7.1の差分計算結果に依存
  - _Requirements: 7.2, 7.3_

- [ ] 7.3 PRワークフローへの統合
  - PR作成・更新イベントでワークフロー実行
  - 差分計算とコメント投稿の自動化
  - ※ 7.1, 7.2に依存
  - _Requirements: 7.1, 7.2, 7.3, 7.4_

- [ ] 8. 統合とE2Eテスト
- [x] 8.1 (P) Parserドメイン統合テスト
  - モックサーバーでGitHub APIコメント取得フロー検証
  - 正常系・異常系（API障害、レート制限）のテスト
  - _Requirements: 1.1, 1.5_

- [x] 8.2 (P) Contentドメイン統合テスト
  - コンテンツ生成からMarkdown出力までの連携検証
  - フォールバック処理の統合テスト
  - _Requirements: 2.1, 2.2, 2.3, 3.4_

- [x] 8.3 (P) Siteドメイン統合テスト
  - Markdownからhtml出力までの連携検証
  - 5件のproposalでHTML生成を確認
  - _Requirements: 4.1, 4.3_

- [x] 8.4 (P) Feedドメイン統合テスト
  - RSS配信の妥当性チェック
  - autodiscoveryタグの検証
  - _Requirements: 5.1, 5.2, 5.3, 5.4, 5.5_

- [x] 8.5 Parse→Content統合テスト
  - モックデータでParse → Content の検証
  - 10件のproposal変更を処理
  - ※ 8.1, 8.2に依存
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 2.1, 2.2, 2.3_

- [x] 8.6 Content→Site統合テスト
  - Content → Site → Feed の連携検証
  - 10件のproposalでビルド完了を確認
  - ※ 8.2, 8.3, 8.4に依存
  - _Requirements: 2.1, 2.2, 2.3, 4.1, 4.3, 5.1_

- [x] 8.7 E2Eテストフィクスチャ作成
  - 10件のproposal変更モックデータを作成
  - 各ドメイン用のテストヘルパーを用意
  - ※ 8.5, 8.6に依存
  - _Requirements: 1.1, 2.1, 4.1_

- [x] 8.8 E2Eパイプライン実行
  - 8.7のフィクスチャを使ってパイプラインを実行
  - 出力ファイル生成の確認
  - ※ 8.7に依存
  - _Requirements: 1.2, 1.3, 1.4, 2.2, 2.3_

- [ ] 8.9 E2E出力検証
  - 生成されたHTML/RSS内容のアサーション
  - フォールバック処理の動作確認
  - ※ 8.8に依存
  - _Requirements: 3.4, 4.3, 5.1_

- [ ] 8.10 パイプライン性能ベンチマーク作成
  - go test -benchでベンチマーク関数を実装
  - 50件データ生成と処理時間計測
  - ※ 8.9に依存
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 2.1, 2.2, 2.3_

- [ ] 8.11 静的サイト生成性能ベンチマーク作成
  - go test -benchでサイト生成ベンチマークを実装
  - 処理時間のアサーション
  - ※ 8.6に依存
  - _Requirements: 4.1, 4.3_

---

## Requirements Coverage

| Requirement | Tasks |
|-------------|-------|
| 1.1 | 2.3, 2.4, 8.1, 8.5, 8.7, 8.10 |
| 1.2 | 2.1, 2.3, 2.4, 8.5, 8.8, 8.10 |
| 1.3 | 2.2, 2.4, 8.5, 8.8, 8.10 |
| 1.4 | 2.3, 2.4, 8.5, 8.8, 8.10 |
| 1.5 | 2.3, 2.4, 8.1 |
| 2.1 | 3.1, 3.4, 8.2, 8.5, 8.6, 8.7, 8.10 |
| 2.2 | 3.1, 3.4, 8.2, 8.5, 8.6, 8.8, 8.10 |
| 2.3 | 3.1, 3.4, 8.2, 8.5, 8.6, 8.8, 8.10 |
| 2.4 | 3.2, 3.4 |
| 2.5 | 3.2, 3.4 |
| 3.1 | 6.4 |
| 3.2 | 3.4, 6.4 |
| 3.3 | 3.3, 3.4, 6.4 |
| 3.4 | 3.3, 3.4, 6.5, 8.2, 8.9 |
| 3.5 | 3.4, 6.4 |
| 4.1 | 4.1, 4.2, 4.3, 4.4, 4.7, 4.10, 8.3, 8.6, 8.7, 8.11 |
| 4.2 | 4.5, 4.10 |
| 4.3 | 4.2, 4.3, 4.4, 4.7, 4.10, 8.3, 8.6, 8.9, 8.11 |
| 4.4 | 4.5, 4.8, 4.10 |
| 4.5 | 4.6, 4.8, 4.10 |
| 4.6 | 4.6, 4.8, 4.10 |
| 5.1 | 4.9, 5.1, 5.3, 8.4, 8.6, 8.9 |
| 5.2 | 5.1, 5.3, 8.4 |
| 5.3 | 5.1, 5.3, 8.4 |
| 5.4 | 4.9, 5.2, 5.3, 8.4 |
| 5.5 | 5.1, 5.3 |
| 6.1 | 6.1, 6.2 |
| 6.2 | 6.3, 6.6 |
| 6.3 | 6.7 |
| 6.4 | 6.8 |
| 6.5 | 6.9, 6.10 |
| 6.6 | 6.11 |
| 7.1 | 7.1, 7.3 |
| 7.2 | 7.2, 7.3 |
| 7.3 | 7.1, 7.2, 7.3 |
| 7.4 | 7.1, 7.3 |
