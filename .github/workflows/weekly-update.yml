name: Weekly Proposal Digest Update

on:
  # Run every Thursday at 12:00 JST (03:00 UTC)
  schedule:
    - cron: "0 3 * * 4"

  # Allow manual trigger
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Parse proposal changes
        id: parse
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Build and run the parse command
          go build -o ./bin/parse ./cmd/parse

          # Run parse command and capture output
          OUTPUT=$(./bin/parse \
            -state content/state.json \
            -output changes.json)

          echo "$OUTPUT"

          # Extract has_changes and set as step output
          HAS_CHANGES=$(echo "$OUTPUT" | grep "has_changes=" | cut -d= -f2)
          CHANGES_COUNT=$(echo "$OUTPUT" | grep "changes_count=" | cut -d= -f2)

          echo "has_changes=$HAS_CHANGES" >> $GITHUB_OUTPUT
          echo "changes_count=$CHANGES_COUNT" >> $GITHUB_OUTPUT

          echo "::notice::Detected $CHANGES_COUNT proposal changes"

      # Task 6.3: Skip control when no changes detected
      - name: Skip notification (no changes)
        if: steps.parse.outputs.has_changes != 'true'
        run: |
          echo "::notice::No proposal changes detected since last run. Skipping subsequent steps."
          echo "Last processed state is up to date."

      # Task 6.4: Generate AI summaries with Claude Code Action
      - name: Generate AI summaries
        id: summaries
        if: steps.parse.outputs.has_changes == 'true'
        continue-on-error: true
        uses: anthropics/claude-code-action@v1
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          prompt: |
            # Go Proposal 週次ダイジェスト生成

            ## あなたの役割
            changes.jsonに記載された各proposalについて、`proposal-researcher`サブエージェントを
            並列起動し、詳細な日本語要約を生成するオーケストレーターです。

            ## 実行手順

            ### Step 1: 変更データの読み込み
            `changes.json` を読み込み、変更されたproposalの一覧を取得してください。
            ファイルが存在しない場合は、`mkdir -p summaries` を実行して終了してください。

            ### Step 2: proposal-researcherサブエージェントの並列起動
            **重要: 全てのproposalを1つのメッセージで同時に並列起動してください。**

            各proposalに対して、Task toolを以下のように呼び出します:

            ```
            Task tool:
              subagent_type: "proposal-researcher"
              description: "Proposal #{issue_number} 調査"
              prompt: |
                以下のproposalを調査し、日本語で詳細な要約を生成してください。

                ## 調査対象
                - Issue番号: {issue_number}
                - タイトル: {title}
                - ステータス変更: {previous_status} → {current_status}
                - Comment URL: {comment_url}

                **重要: 最終出力は要約のMarkdownのみとしてください。**
                「これで十分な情報が集まりました」「要約を作成します」などの
                前置きや説明文は一切含めず、要約本文のMarkdownだけを出力してください。
            ```

            **並列実行例（3件の場合）:**
            1つのメッセージ内で3つのTask tool呼び出しを同時に行う:
            - Task 1: proposal-researcher for issue #12345
            - Task 2: proposal-researcher for issue #67890
            - Task 3: proposal-researcher for issue #11111

            ### Step 3: 結果の書き出し
            各サブエージェントからの調査結果を `summaries/{issue_number}.md` に書き出してください。

            **重要: 前置き文の除外**
            サブエージェントが「これで十分な情報が集まりました」「要約を作成します」などの
            前置きや説明文を含めて出力した場合、それらを除外してMarkdown要約部分のみを保存してください。
            要約本文のMarkdownだけがファイルに保存されるようにしてください。

            ## 注意事項
            - changes.jsonが存在しない場合は、空のsummariesディレクトリを作成して終了
            - **必ず全proposalを並列で調査すること**（1つのメッセージで複数のTask toolを呼び出す）
            - 各サブエージェントの調査は独立しているため、互いの結果を待つ必要はない
            - サブエージェントが詳細な調査（Phase 1-3）を実行するため、オーケストレーターは結果の取りまとめに集中
          claude_args: |
            --max-turns 60
            --allowedTools Read,Write,Bash,Task,Grep,Glob,WebSearch,WebFetch

      # Task 6.5: Handle summary generation failure
      - name: Check summary generation result
        id: summary_check
        if: steps.parse.outputs.has_changes == 'true'
        run: |
          if [ "${{ steps.summaries.outcome }}" == "failure" ]; then
            echo "summary_failed=true" >> $GITHUB_OUTPUT
            echo "::warning::Claude Code Action failed. Fallback summaries will be generated."
          else
            echo "summary_failed=false" >> $GITHUB_OUTPUT
            echo "::notice::AI summaries generated successfully."
          fi

      - name: Generate fallback summaries
        if: steps.parse.outputs.has_changes == 'true' && steps.summary_check.outputs.summary_failed == 'true'
        run: |
          echo "::group::Generating fallback summaries"

          # Create summaries directory if it doesn't exist
          mkdir -p summaries

          # Read changes.json and generate basic fallback summaries
          if [ -f "changes.json" ]; then
            # Use jq to process each change and generate fallback markdown
            jq -c '.changes[]' changes.json | while read -r change; do
              issue_number=$(echo "$change" | jq -r '.issue_number')
              title=$(echo "$change" | jq -r '.title')
              prev_status=$(echo "$change" | jq -r '.previous_status')
              curr_status=$(echo "$change" | jq -r '.current_status')
              comment_url=$(echo "$change" | jq -r '.comment_url')

              cat > "summaries/${issue_number}.md" << EOF
          このproposalは「${title}」として提案されており、今回のレビューで**${prev_status}**から**${curr_status}**にステータスが変更されました。

          詳細な技術的背景については、関連リンクからissueの議論をご確認ください。

          ## 関連リンク
          - [Proposal Issue](https://github.com/golang/go/issues/${issue_number})
          - [Review Comment](${comment_url})
          EOF

              echo "Generated fallback summary for issue #${issue_number}"
            done
          else
            echo "::warning::changes.json not found. No fallback summaries generated."
          fi

          echo "::endgroup::"

      # Task 6.5.1: Integrate changes and summaries into content files
      - name: Integrate content
        if: steps.parse.outputs.has_changes == 'true'
        run: |
          echo "::group::Integrating changes and summaries into content"

          # Build the integrate command
          go build -o ./bin/integrate ./cmd/integrate

          # Run integrate to create/update content files
          # This command:
          # - Reads changes.json for proposal changes
          # - Reads summaries from summaries/ directory
          # - Tracks previous_status from existing content history
          # - Writes merged content to content/ directory
          ./bin/integrate \
            -changes changes.json \
            -content content \
            -summaries summaries

          echo "::endgroup::"
          echo "::notice::Content integration completed successfully"

      # Task 6.6: Build static site
      - name: Setup Node.js
        if: steps.parse.outputs.has_changes == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install npm dependencies
        if: steps.parse.outputs.has_changes == 'true'
        run: npm ci

      - name: Build static site
        id: build
        if: steps.parse.outputs.has_changes == 'true'
        run: |
          echo "::group::Building static site"

          # Run full build pipeline: templ generate → Go build → frontend → HTML/RSS
          make build

          echo "::endgroup::"
          echo "::notice::Static site build completed successfully"

      # Task 6.7: Commit generated files to main branch
      - name: Commit changes
        id: commit
        if: steps.parse.outputs.has_changes == 'true'
        run: |
          echo "::group::Committing generated files"

          # Configure git user
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          # Add generated files
          # - dist/: Generated HTML, CSS, JS, RSS files
          # - content/: Markdown content and state.json
          # - summaries/: AI-generated summaries (temporary, but useful for debugging)
          git add dist/ content/ summaries/ || true

          # Check if there are staged changes
          if git diff --staged --quiet; then
            echo "has_commits=false" >> $GITHUB_OUTPUT
            echo "::notice::No file changes to commit."
          else
            # Create commit with descriptive message
            WEEK=$(date -u +"%Y-W%V")
            CHANGES_COUNT="${{ steps.parse.outputs.changes_count }}"

            git commit -m "chore: update weekly digest ${WEEK}" \
              -m "- Updated ${CHANGES_COUNT} proposal(s)" \
              -m "- Generated by weekly-update workflow" \
              -m "[skip ci]"

            echo "has_commits=true" >> $GITHUB_OUTPUT
            echo "::notice::Committed changes for ${CHANGES_COUNT} proposal(s)."
          fi

          echo "::endgroup::"

      - name: Push changes
        if: steps.parse.outputs.has_changes == 'true' && steps.commit.outputs.has_commits == 'true'
        run: |
          # Push to main for scheduled runs, to the triggering branch for manual runs
          TARGET_BRANCH="${{ github.event_name == 'workflow_dispatch' && github.ref_name || 'main' }}"
          git push origin "$TARGET_BRANCH"
